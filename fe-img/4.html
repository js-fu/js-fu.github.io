<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4 ajax 预加载</title>
    <style>
      html,
      body {
        height: 100%;
        overflow: auto;
      }

      body {
        margin: 0;
      }

      .list .item img {
        width: 300px;
        min-height: 200px;
      }

      .list .item + .item {
        margin-top: 20px;
      }

      .preload-container {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .preload-container--hide {
        display: none;
      }

      .preload-loading {
        width: 300px;
        height: 14px;
        background-color: #fff;
      }

      .preload-loading-bar {
        height: 100%;
        width: 0;
        background-color: green;
        transition: 0.3s;
      }

      .preload-text {
        text-align: center;
        color: green;
      }
    </style>
  </head>

  <body>
    <h2>图文列表</h2>
    <div class="list"></div>

    <div class="preload-container">
      <div class="preload-body">
        <div class="preload-loading">
          <div class="preload-loading-bar"></div>
        </div>
        <div class="preload-text"></div>
      </div>
    </div>

    <script>
      function preload({ imgs, onProgress }) {
        let count = 0;
        const imgObj = {};

        imgs.forEach((img) => {
          const image = new Image();
          image.src = img.src;

          function loaded(image) {
            count++;
            imgObj[img.name] = image;
            onProgress(count, imgs.length, imgObj);
          }

          if (image.complete) {
            loaded(image);
          } else {
            image.onload = function () {
              loaded(image);
            };
          }
        });
      }

      function showPreloadMask(value) {
        const preloadMaskEl = document.querySelector(".preload-container");
        preloadMaskEl.classList[value ? "remove" : "add"](
          "preload-container--hide"
        );
      }

      function setProgress(value) {
        const preloadLoadingBarEl = document.querySelector(
          ".preload-loading-bar"
        );
        preloadLoadingBarEl.style.width = `${value}%`;

        const preloadTextEl = document.querySelector(".preload-text");
        preloadTextEl.innerHTML = `${value}%`;
      }

      function handleDOMContentLoaded(event) {
        function getImgList(callback) {
          setTimeout(function handleTimer() {
            const list = [
              {
                name: "lf",
                img: "./img/lf.jpg",
                desc:
                  "蒙奇·D·路飞（モンキー・D・ルフィ，Monkey·D·Luffy）是尾田荣一郎创作的日本漫画《航海王》中的主角。他是一个年轻的海贼，外号“草帽小子”，吃下“橡胶果实”而能让身体像橡胶一样伸缩自如的橡胶人，路飞透过自己的橡胶身体进行变化、发展各种招式和技能，例如伸长手臂后击出的拳头“橡胶枪”。",
              },
              {
                name: "zl",
                img: "./img/zl.png",
                desc:
                  "罗罗亚·佐罗（ロロノア・ゾロ）是日本漫画家尾田荣一郎所创作的少年漫画《航海王》中的虚构角色，是该作品的中的一位主要角色，是主角路飞的第一位伙伴，草帽海贼团的战斗员。他立志成为世界最强的剑士，他以双手持刀、嘴上再咬一把刀的三刀流战斗风格闻名，一名路痴，路人的指示下也会走错，团员中第二号人物。",
              },
              {
                name: "sz",
                img: "./img/sz.jpg",
                desc:
                  "文斯莫克·山智（ヴィンスモーク・サンジ）是日本漫画家尾田荣一郎所创作的少年漫画《航海王》中的虚构角色，是该作品的中的一位主要角色，是主角路飞的第4位伙伴，草帽海贼团的厨师。有着在团队不利时会主动出击的“奇兵”和担任策士的实绩。以独特的踢技战斗风格闻名，有着骑士道精神，热爱女性，是个狂热的“拥女主义者”的绅士。",
              },
              {
                name: "nm",
                img: "./img/nm.jpg",
                desc:
                  "奈美（ナミ）是日本漫画家尾田荣一郎所创作的少年漫画《航海王》中的虚构角色，是该作品的中的一位主要角色，是主角路飞的第二位伙伴，草帽海贼团的航海士。她是位懂得制图、精通气象和航海的小偷，梦想是完成世界地图。",
              },
              {
                name: "qb",
                img: "./img/qb.jpg",
                desc:
                  "多尼多尼·乔巴（トニートニー・チョッパー）是日本漫画家尾田荣一郎所创作的少年漫画《ONE PIECE》中的虚构角色，是该作品的中的一位主要角色，是主角蒙其·D·鲁夫的第5位伙伴，草帽海贼团的船医。他是一只有蓝鼻子的驯鹿医生，因为吃下的“人人果实”让他得到了能变成兽人的特殊能力，梦想是透过学习医术而让自己成为万灵药。",
              },
              {
                name: "wsp",
                img: "./img/wsp.jpg",
                desc:
                  "撒谎布（ウソップ）是日本漫画家尾田荣一郎所创作的少年漫画《航海王》中的虚构角色，是该作品的中的一位主要角色。是主角路飞的第三位伙伴，草帽海贼团的狙击手。虽然他个性悲观懦弱，但他立志成为勇敢的海上战士。",
              },
              {
                name: "lb",
                img: "./img/lb.jpg",
                desc:
                  "妮可·罗宾 （ニコ・ロビン）是日本漫画家尾田荣一郎所创作的少年漫画《航海王》中的虚构角色，是该作品的中的一位主要角色，是主角蒙其·D·鲁夫的第6位伙伴，草帽海贼团的考古学家。罗宾是考古学之岛“欧哈拉”的遗孤。她的梦想是透过找到散落在《航海王》世界中一种被称为历史本文的文献，以查明被消除的历史。",
              },
              {
                name: "blk",
                img: "./img/blk.jpeg",
                desc:
                  "布鲁克（ブルック）是日本漫画家尾田荣一郎所创作的少年漫画《航海王》中的虚构角色，是该作品的中的一位主要角色。是主角鲁夫的第8位伙伴，草帽海贼团的音乐家。他的外表是一具爆炸头骷髅，同时是一名剑击高手。梦想是绕世界一圈后回到颠倒山双子峡跟拉布重逢。",
              },
              {
                name: "franky",
                img: "./img/franky.jpeg",
                desc:
                  "佛朗基（フランキー）是日本漫画家尾田荣一郎所创作的少年漫画《航海王》中的虚构角色，是该作品的中的一位主要角色，是主角蒙其·D·鲁夫的第7位伙伴，草帽海贼团的船匠。他是一名改造人，全身上下充满各种机械装置和武器。佛朗基本来是想制造出梦想之船，但千阳号完成后，只想看到自己制造的船能到达世界尽头。",
              },
            ];
            callback(list);
          }, 100);
        }

        getImgList(function handleGetImgListCallback(list) {
          showPreloadMask(true);
          setProgress(0);
          preload({
            imgs: list.map(({ name, img }) => ({ name, src: img })),
            onProgress: function (done, total, imgObj) {
              console.log(done, total, imgObj);

              const progress = ((done / total) * 100).toFixed(2);
              setProgress(progress);

              if (progress == 100) {
                setTimeout(() => {
                  showPreloadMask(false);
                  const imgListEl = document.querySelector(".list");
                  const fragmentEl = document.createDocumentFragment();

                  for (const item of list) {
                    const itemEl = document.createElement("div");
                    itemEl.className = "item";

                    const imgEl = document.createElement("img");
                    imgEl.src = item.img;
                    itemEl.appendChild(imgEl);

                    const pEl = document.createElement("p");
                    pEl.innerText = item.desc;
                    itemEl.appendChild(pEl);

                    fragmentEl.appendChild(itemEl);
                  }

                  imgListEl.appendChild(fragmentEl);
                }, 300);
              }
            },
          });
        });
      }

      document.addEventListener("DOMContentLoaded", handleDOMContentLoaded);
    </script>
  </body>
</html>
